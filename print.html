<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>RuxOS Book</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->
        
        <meta name="description" content="RuxOS guide book">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="Introduction.html">Introduction</a></li><li class="chapter-item expanded affix "><li class="part-title">About RuxOS</li><li class="chapter-item expanded "><a href="chap01/Overview.html"><strong aria-hidden="true">1.</strong> RuxOS overview</a></li><li class="chapter-item expanded affix "><li class="part-title">Getting Started with RuxOS</li><li class="chapter-item expanded "><a href="chap02/getstarted.html"><strong aria-hidden="true">2.</strong> Get Started</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="chap02/arguments.html"><strong aria-hidden="true">2.1.</strong> Arguments</a></li><li class="chapter-item expanded "><a href="chap02/apps/root.html"><strong aria-hidden="true">2.2.</strong> Existing apps</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="chap02/apps/helloworld.html"><strong aria-hidden="true">2.2.1.</strong> Hello World!</a></li><li class="chapter-item expanded "><a href="chap02/apps/iperf.html"><strong aria-hidden="true">2.2.2.</strong> Iperf3</a></li><li class="chapter-item expanded "><a href="chap02/apps/sqlite.html"><strong aria-hidden="true">2.2.3.</strong> Sqlite</a></li><li class="chapter-item expanded "><a href="chap02/apps/redis.html"><strong aria-hidden="true">2.2.4.</strong> Redis</a></li><li class="chapter-item expanded "><a href="chap02/apps/nginx.html"><strong aria-hidden="true">2.2.5.</strong> Nginx</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="chap03/your_app.html"><strong aria-hidden="true">3.</strong> Your App</a></li><li class="chapter-item expanded "><a href="chap04/ruxgo.html"><strong aria-hidden="true">4.</strong> Build from ruxgo</a></li><li class="chapter-item expanded "><a href="chap05/multiplatforms.html"><strong aria-hidden="true">5.</strong> Multi-Platforms</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="chap05/Raspi4.html"><strong aria-hidden="true">5.1.</strong> Raspi4</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Architeture and Design</li><li class="chapter-item expanded "><a href="chap06/design_overview.html"><strong aria-hidden="true">6.</strong> Design Overview</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="chap06/crates/crates.html"><strong aria-hidden="true">6.1.</strong> Crates</a></li><li class="chapter-item expanded "><a href="chap06/modules/modules.html"><strong aria-hidden="true">6.2.</strong> Modules</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="chap06/modules/9pfs.html"><strong aria-hidden="true">6.2.1.</strong> 9pfs</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="chap07/ulib/ulib.html"><strong aria-hidden="true">7.</strong> User Library</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="chap07/ulib/ruxos-posix-api.html"><strong aria-hidden="true">7.1.</strong> ruxos-posix-api</a></li><li class="chapter-item expanded "><a href="chap07/ulib/ruxlibc.html"><strong aria-hidden="true">7.2.</strong> ruxlibc</a></li><li class="chapter-item expanded "><a href="chap07/ulib/ruxmusl.html"><strong aria-hidden="true">7.3.</strong> ruxmusl</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Future Work</li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.</strong> TODO</div></li><li class="spacer"></li><li class="chapter-item expanded affix "><a href="Contributors.html">CONTRIBUTORS</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">RuxOS Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/syswonder/ruxos" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="welcome-to-ruxos-world"><a class="header" href="#welcome-to-ruxos-world">Welcome to RuxOS world!</a></h1>
<p>This is RuxOS book, which covers following points:</p>
<ul>
<li>
<p>RuxOS overview.</p>
</li>
<li>
<p>Getting started with RuxOS apps.</p>
</li>
<li>
<p>RuxOS design.</p>
</li>
</ul>
<p>RuxOS Book is still working in progress. </p>
<h1 id="what-is-ruxos"><a class="header" href="#what-is-ruxos">What is RuxOS?</a></h1>
<p>RuxOS is a lightweight library operating system compatible with Linux applications, mainly following the <a href="https://en.wikipedia.org/wiki/Unikernel">unikernel</a> design idea, maintained by <a href="https://www.syswonder.org/#/">syswonder community</a>.</p>
<p>Considering that in edge ubiquitous computing scenarios, the number of applications is usually limited and relatively fixed, so the operating system is simplified and designed to only support a single application and encapsulates the kernel functions. As a library, it is provided to applications in the form of system calls, and applications run directly in the kernel state. </p>
<p>The performance of operating system applications in this library form will be greatly improved, and security issues will be mainly solved by the underlying Type 1 hypervisor (<a href="https://github.com/syswonder/hvisor">hvisor</a>). Library-shaped operating systems require good tool support to facilitate users to generate and construct runnable binary images based on a single application, such as <a href="https://unikraft.org/">unikraft</a>.</p>
<p>RuxOS is still working in progress, and we appriciate your contributions.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ruxos-overview"><a class="header" href="#ruxos-overview">RuxOS Overview</a></h1>
<p>In this Chapter, RuxOS book will give you a brief introduction about RuxOS.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="get-started"><a class="header" href="#get-started">Get Started</a></h1>
<p>In this chapter, we will cover:</p>
<ul>
<li>
<p>Arguments explanations.</p>
</li>
<li>
<p>How to run existing applications on RuxOS.</p>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="arguments"><a class="header" href="#arguments">Arguments</a></h1>
<p>RuxOS provide many, but flexible and pricise arguments to build and run various applications. </p>
<p><strong>General options</strong> about building process:</p>
<div class="table-wrapper"><table><thead><tr><th>General Options</th><th></th></tr></thead><tbody>
<tr><td>ARCH</td><td>Target architecture: x86_64, riscv64, aarch64. Default value is x86_64.</td></tr>
<tr><td>PLATFORM</td><td>Target platform in the <code>platforms</code> directory. This can be user-specified or generated automatically by <code>ARCH</code>.</td></tr>
<tr><td>SMP</td><td>Number of CPUs. If this is greater than one, multiple cores will be started. Default is one.</td></tr>
<tr><td>MODE</td><td>Build mode: release, debug, corresponed to <code>cargo build</code> mode. Default is release.</td></tr>
<tr><td>LOG</td><td>Logging level: warn, error, info, debug, trace. Default is warn.</td></tr>
<tr><td>V</td><td>Verbose level: (empty), 1, 2</td></tr>
<tr><td>ARGS</td><td>Command-line arguments separated by comma, which can be none. It is used to pass specific variables, like <code>argc</code>, <code>argv</code>.</td></tr>
<tr><td>ENVS</td><td>Environment variables, separated by comma between key value pairs, which can be none.</td></tr>
</tbody></table>
</div>
<p><strong>Application options</strong> about the application directory and features:</p>
<div class="table-wrapper"><table><thead><tr><th>App Options</th><th></th></tr></thead><tbody>
<tr><td>A/APP</td><td>Path to the application directory.Both relative and absolute path are right. Default path points to <code>apps/c/helloworld.</code></td></tr>
<tr><td>FEATURES</td><td>Features of Ruxos modules to be enabled. This can be used to specific features without modifying corresponding <code>features.txt</code></td></tr>
<tr><td>APP_FEATURES</td><td>Features of (rust) apps to be enabled.</td></tr>
</tbody></table>
</div>
<p><strong>Qemu options</strong>, mainly used to enable qemu startup parameters:</p>
<div class="table-wrapper"><table><thead><tr><th>Qemu Options</th><th></th></tr></thead><tbody>
<tr><td>BLK</td><td>Enable storage devices (virtio-blk). This should be enabled for data persistence and configuration file passing via root filesystem.</td></tr>
<tr><td>NET</td><td>Enable network devices (virtio-net). This shoule be enabled if applications need network service.</td></tr>
<tr><td>GRAPHIC</td><td>Enable display devices and graphic output (virtio-gpu).</td></tr>
<tr><td>V9P</td><td>Enable virtio-9p devices.</td></tr>
<tr><td>BUS</td><td>Device bus type: mmio, pci.</td></tr>
<tr><td>DISK_IMG</td><td>Path to the virtual disk image. Default value is <code>/path/to/RuxOS/disk.img</code>.</td></tr>
<tr><td>ACCEL</td><td>Enable hardware acceleration (KVM on linux).</td></tr>
<tr><td>QEMU_LOG</td><td>Enable QEMU logging (log file is &quot;qemu.log&quot;) to dump out assembly code.</td></tr>
<tr><td>NET_DUMP</td><td>Enable network packet dump (log file is &quot;netdump.pcap&quot;).</td></tr>
<tr><td>NET_DEV</td><td>QEMU netdev backend types: user, tap.</td></tr>
</tbody></table>
</div>
<p><strong>9P options</strong> used to configure 9pfs:</p>
<div class="table-wrapper"><table><thead><tr><th>9P Options</th><th></th></tr></thead><tbody>
<tr><td>V9P_PATH</td><td>Host path for backend of virtio-9p, points to the shared directory on host. Default value is RuxOS root directory.</td></tr>
<tr><td>NET_9P_ADDR</td><td>Server address and port for 9P netdev. Default value is <code>127.0.0.1:564</code>.</td></tr>
<tr><td>ANAME_9P</td><td>Path for root of 9pfs(parameter of TATTACH for root).</td></tr>
<tr><td>PROTOCOL_9P</td><td>Default protocol version selected for 9P.</td></tr>
</tbody></table>
</div>
<p><strong>Network options</strong>, default port is 5555:</p>
<div class="table-wrapper"><table><thead><tr><th>Network Options</th><th></th></tr></thead><tbody>
<tr><td>IP</td><td>Ruxos IPv4 address (default is 10.0.2.15 for QEMU user netdev).</td></tr>
<tr><td>GW</td><td>Gateway IPv4 address (default is 10.0.2.2 for QEMU user netdev).</td></tr>
</tbody></table>
</div>
<p><strong>Libc options</strong> for libc selection:</p>
<div class="table-wrapper"><table><thead><tr><th>Libc Options</th><th></th></tr></thead><tbody>
<tr><td>MUSL</td><td>Compile, link C app with musl libc. By default, RuxOS use <code>ruxlibc</code>. Users can specify <code>MUSL=y</code> to enable musl-libc.</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="apps"><a class="header" href="#apps">apps</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="hello-world"><a class="header" href="#hello-world">Hello World!</a></h1>
<p>RuxOS uses the <code>make</code> tool to provide users with a complete and convenient way to run applications.</p>
<p>For a basic hello world app:</p>
<pre><code>make A=apps/c/helloworld run
</code></pre>
<p>Parameter explanation:</p>
<ul>
<li><code>A</code>: This parameter points to the application directory.</li>
</ul>
<p>Just run this command, and a simple c app is started. An example of running results is as follows:</p>
<pre><code>8888888b.                     .d88888b.   .d8888b.  
888   Y88b                   d88P&quot; &quot;Y88b d88P  Y88b 
888    888                   888     888 Y88b.      
888   d88P 888  888 888  888 888     888  &quot;Y888b.   
8888888P&quot;  888  888 `Y8bd8P' 888     888     &quot;Y88b. 
888 T88b   888  888   X88K   888     888       &quot;888 
888  T88b  Y88b 888 .d8&quot;&quot;8b. Y88b. .d88P Y88b  d88P 
888   T88b  &quot;Y88888 888  888  &quot;Y88888P&quot;   &quot;Y8888P&quot; 

arch = x86_64
platform = x86_64-qemu-q35
target = x86_64-unknown-none
smp = 1
build_mode = release
log_level = error

Hello, C app!
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="iperf3"><a class="header" href="#iperf3">Iperf3</a></h1>
<p><a href="https://github.com/esnet/iperf">iPerf3</a> is a tool for active measurements of the maximum achievable bandwidth on IP networks.</p>
<h2 id="build--run"><a class="header" href="#build--run">Build &amp; run</a></h2>
<p>Build and start the <a href="https://github.com/esnet/iperf"><code>iperf3</code></a> server on Ruxos:</p>
<pre><code class="language-bash"># in ruxos root directory
make A=apps/c/iperf BLK=y NET=y ARCH=&lt;arch&gt; run
</code></pre>
<h2 id="benchmark"><a class="header" href="#benchmark">Benchmark</a></h2>
<p>In another shell, run the <code>iperf3</code> client:</p>
<ul>
<li>
<p>iperf on Ruxos as the receiver:</p>
<pre><code class="language-bash"># TCP
iperf3 -c 127.0.0.1 -p 5555
# UDP
iperf3 -uc 127.0.0.1 -p 5555 -b &lt;sender_bitrate&gt; -l &lt;buffer_len&gt;
</code></pre>
<p>You need to set the <code>&lt;sender_bitrate&gt;</code> (in bits/sec) to avoid sending packets too fast from the client when use UDP.</p>
</li>
<li>
<p>iperf on Ruxos as the sender:</p>
<pre><code class="language-bash"># TCP
iperf3 -c 127.0.0.1 -p 5555 -R
# UDP
iperf3 -uc 127.0.0.1 -p 5555 -b 0 -l &lt;buffer_len&gt; -R
</code></pre>
</li>
</ul>
<p>By default, the <code>&lt;buffer_len&gt;</code> is 128 KB for TCP and 8 KB for UDP. Larger buffer length may improve the performance. You can change it by the <code>-l</code> option of <code>iperf3</code>.</p>
<p>Note that if the <code>&lt;buffer_len&gt;</code> is greater than <code>1472</code> (total packet length is exceeded the MTU of the NIC) when use UDP, packets fragmentation will occur. You should enable fragmentation features in <a href="https://github.com/smoltcp-rs/smoltcp">smoltcp</a>:</p>
<pre><code class="language-toml"># in ruxos/modules/axnet/Cargo.toml
[dependencies.smoltcp]
git = &quot;https://github.com/rcore-os/smoltcp.git&quot;
rev = &quot;2ade274&quot;
default-features = false
features = [
  &quot;alloc&quot;, &quot;log&quot;,   # no std
  &quot;medium-ethernet&quot;,
  &quot;proto-ipv4&quot;,
  &quot;socket-raw&quot;, &quot;socket-icmp&quot;, &quot;socket-udp&quot;, &quot;socket-tcp&quot;, &quot;socket-dns&quot;,
  # &quot;fragmentation-buffer-size-65536&quot;, &quot;proto-ipv4-fragmentation&quot;,
  # &quot;reassembly-buffer-size-65536&quot;, &quot;reassembly-buffer-count-32&quot;,
  # &quot;assembler-max-segment-count-32&quot;,
]
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="sqlite"><a class="header" href="#sqlite">Sqlite</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="redis"><a class="header" href="#redis">Redis</a></h1>
<p>RuxOS supports Redis Server on Qemu.</p>
<h2 id="create-diskimg"><a class="header" href="#create-diskimg">Create disk.img</a></h2>
<p>Run following command at root directory of RuxOS. </p>
<pre><code class="language-shell">make disk_img
</code></pre>
<p>This command will create <code>disk.img</code> to store data, and this image will be passed to qemu as a disk image.</p>
<h2 id="run-redis-server"><a class="header" href="#run-redis-server">Run Redis-Server</a></h2>
<p>Run following command to start a redis server at port 5555.</p>
<pre><code class="language-shell">make A=apps/c/redis/ LOG=error NET=y BLK=y ARCH=aarch64 SMP=4 ARGS=&quot;./redis-server,--bind,0.0.0.0,--port,5555,--save,\&quot;\&quot;,--appendonly,no,--protected-mode,no,--ignore-warnings,ARM64-COW-BUG&quot; run
</code></pre>
<p>Parameter explanation:</p>
<ul>
<li><code>A</code>: This paramter points to the directory where redis is placed. </li>
<li><code>LOG</code>: <code>LOG</code> indicates the log level, which includes: <code>error</code>,  <code>warn</code>, <code>info</code>, <code>debug</code>, <code>trace</code>.</li>
<li><code>NET</code>: <code>NET</code> indicates that net device (virtio-net) is enabled.</li>
<li><code>BLK</code>: <code>BLK</code> indicates that storage device (virtio-blk) is enabled.</li>
<li><code>ARCH</code>: <code>ARCH</code> indicates what architecture RuxOS is running on, which covers: <code>x86_64</code>, <code>aarch64</code>, <code>riscv64</code>.</li>
<li><code>SMP</code>: <code>SMP</code> enables multi-core feature in RuxOS. The following number indicates the number of the cores.</li>
<li><code>ARGS</code>: <code>ARGS</code> provides the parameters needed for the redis-server to run. RuxOS binds redis server on 0.0.0.0:5555.</li>
</ul>
<p>After running this command, a Redis Server is started on port 5555.</p>
<h2 id="connect-to-redis-server"><a class="header" href="#connect-to-redis-server">Connect to Redis-Server</a></h2>
<p>It is recommended to use <a href="https://redis.io/resources/tools/">redis tools</a> to connect to Redis Server by:</p>
<pre><code class="language-shell">sudo apt install redis-tools
</code></pre>
<h3 id="redis-cli"><a class="header" href="#redis-cli">redis-cli</a></h3>
<p>Then you can use:</p>
<pre><code class="language-shell">redis-cli -p 5555
</code></pre>
<p>Then it is nothing different from a linux redis server.</p>
<h3 id="redis-benchmark"><a class="header" href="#redis-benchmark">redis-benchmark</a></h3>
<p>Use the Redis benchmark testing tool to test:</p>
<pre><code class="language-shell">redis-benchmark -p 5555
</code></pre>
<p>More parameters can be found on <a href="https://redis.io/docs/management/optimization/benchmarks/">Redis Benchmark</a>.</p>
<h2 id="use-musl-libc"><a class="header" href="#use-musl-libc">Use Musl libc</a></h2>
<p>By default, RuxOS Redis Server is supported by ruxlibc, which is a customized standard C library. </p>
<p>By adding <code>MUSL=y</code> to the make command, redis server will be compiled, linked by standard Musl libc.</p>
<h2 id="use-9pfs"><a class="header" href="#use-9pfs">Use 9pfs</a></h2>
<p>By default, RuxOS passes application arguments by <code>ARGS</code>, which can be inconvenient. RuxOS successfully integrate 9p protocol, and provide 9pfs to share directories and files between host and qemu. </p>
<p>Run following command:</p>
<pre><code class="language-shell">make A=apps/c/redis/ LOG=error NET=y V9P=y BLK=y V9P_PATH=apps/c/redis ARCH=aarch64 SMP=4 ARGS=&quot;./redis-server,/v9fs/redis.conf&quot; run
</code></pre>
<p>Parameter explanation:</p>
<ul>
<li><code>V9P</code>: Use <code>V9P=y</code> to enable virtio-9p on qemu.</li>
<li><code>V9P_PATH</code>: <code>V9P_PATH</code> points to the shared directory, which contains the redis configuration file.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nginx"><a class="header" href="#nginx">Nginx</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="your-app"><a class="header" href="#your-app">Your App</a></h1>
<p>This part will give some instructions about how to run specific applications on RuxOS.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="build-from-ruxgo"><a class="header" href="#build-from-ruxgo">Build from ruxgo</a></h1>
<p>This chapter will cover:</p>
<ul>
<li>
<p>What ruxgo is</p>
</li>
<li>
<p>How to use ruxgo to build existing RuxOS apps</p>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="multi-platforms"><a class="header" href="#multi-platforms">Multi-Platforms</a></h1>
<p>This part may cover the guidelines of how to run RuxOS on different platforms, like qemu or real hardware.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="raspi4"><a class="header" href="#raspi4">Raspi4</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="design-overview"><a class="header" href="#design-overview">Design Overview</a></h1>
<p>RuxOS structure will be explained here, and design diagram will be put here.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="crates"><a class="header" href="#crates">Crates</a></h1>
<p>This part will cover the importrance of RuxOS crates and introduction about some crates.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="modules"><a class="header" href="#modules">Modules</a></h1>
<p>This part will cover the introduction of some important modules of RuxOS. </p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="9pfs"><a class="header" href="#9pfs">9pfs</a></h1>
<p>This chapter mainly introduces an overview of 9p protocol and how to use the 9pfs module of RuxOS.</p>
<p>9PFS, 9p-filesystem, is a file system based on the 9P protocol that reads and writes the server-side file system.</p>
<p>In RuxOS, 9pfs corresponds to two different features, namely <code>virtio-9p</code> and <code>net-9p</code>. Among them, <code>virtio-9p</code> is based on the <code>virtio-9p</code> virtual device in the hypervisor to communicate and control the reading and writing of the host file system, while <code>net-9p</code> realizes connection communication and controls the server-side file system through the network TCP protocol. These two different features can be enabled at the same time and work properly.</p>
<p>9P protocol is basically a communication protocol used for file sharing. It is a the session layer protocol. This means that 9P has nothing to do with the physical layer, data link layer, etc. There are three versions of 9P communication protocol: <code>9P2000</code>, <code>9P2000.L</code> and <code>9P2000.u</code>. For the protocol content, please refer to the following link:</p>
<ul>
<li><a href="https://ericvh.github.io/9p-rfc/rfc9p2000.html">Basic protocol content of 9P2000</a></li>
<li><a href="https://github.com/chaos/diod/blob/master/protocol.md">9P2000.L extended protocol version</a></li>
<li><a href="http://ericvh.github.io/9p-rfc/rfc9p2000.u.html">9P2000.u extended protocol version</a></li>
</ul>
<h2 id="virtio-9p"><a class="header" href="#virtio-9p">virtio-9p</a></h2>
<p>In order to use <code>virtio-9p</code>, users should add this feature to the APP.</p>
<p>For C applications, add a line under features.txt in the APP directory:</p>
<pre><code class="language-txt">virtio-9p
</code></pre>
<p>For Rust applications,  add the <code>virtio-9p</code> feature to the axstd feature of Cargo.toml in the APP directory, as follows (this example is Cargo.toml in <code>application/fs/shell</code>):</p>
<pre><code class="language-txt">axstd = { path = &quot;../../../ulib/axstd&quot;, features = [&quot;alloc&quot;, &quot;fs&quot;, &quot;virtio-9p&quot;], optional = true }
</code></pre>
<p>Then, in order to enable the host (currently qemu-system-aarch64) to enable the virtio-9p backend, you need to add the parameter <code>V9P=y</code> to the <code>make</code> command line.</p>
<p>For example:</p>
<pre><code class="language-shell">make A=xxxx LOG=error V9P=y V9P_PATH=xxxx ARCH=xxxx
</code></pre>
<p><code>V9P_PATH</code> is an <strong>environment variable</strong>, corresponding to the file directory mapping path of the host. If this parameter is not set, it will be the current directory <code>./</code>.</p>
<p>After completing the above steps, you can create a <code>v9fs</code> directory in the root directory (or load it as a root file system if <code>blkfs</code> is not specified in features.txt). This directory should contain the file directory mapped by the host backend. For example, when <code>V9P_PATH=./temp/</code>, the v9fs (or root file) directory will be consistent with the ./temp directory.</p>
<p>In addition, RuxOS provide more flexible parameters:</p>
<ul>
<li><code>V9P_PATH</code>: Default value is current directory. This parameter specified the shared directory on the host.</li>
<li><code>PROTOCOL_9P</code>: The 9P protocol selected, which can be either <code>9P2000.L</code> or <code>9P2000.u</code>. Default value is <code>9P2000.L</code>.</li>
</ul>
<h2 id="net-9p"><a class="header" href="#net-9p">net-9p</a></h2>
<p>In order to use <code>net-9p</code>, users should add this feature to the APP.</p>
<p>For C applications, add a line under features.txt in the APP directory:</p>
<pre><code class="language-txt">net-9p
</code></pre>
<p>For Rust applications, add the <code>net-9p</code> feature to the axstd feature of Cargo.toml in the APP directory, as follows:</p>
<pre><code class="language-txt">axstd = { path = &quot;../../../ulib/axstd&quot;, features = [&quot;alloc&quot;, &quot;fs&quot;, &quot;net-9p&quot;], optional = true }
</code></pre>
<p>Then, <code>net-9p</code> protocol needs TCP protocol to communicate, so the parameter <code>NET=y</code> needs to be added to the <code>make</code> command line.</p>
<p>For example:</p>
<pre><code class="language-shell">make A=xxxx LOG=error NET=y ARCH=xxxx
</code></pre>
<p>After completing the above steps, a directory named <code>v9fs</code> is created at the root directory (or loaded as root directory if <code>blkfs</code> is specified). This directory contains the file directory mapped by the host backend. The specific path of the <code>net-9p</code> backend mapping may need to be controlled through <code>ANAME_9P</code>, but this depends on the design of the server side (it may also be passed in parameters when starting the server or changing some server-side codes).</p>
<p>In addition, RuxOS provide more flexible parameters for users:</p>
<ul>
<li><code>NET_9P_ADDR</code>: The IP address and PORT port number of the 9P server. The default value is <code>127.0.0.1:564</code>.</li>
<li><code>ANAME_9P</code>: The aname path parameter corresponding to <code>tattach</code>, which can be set to the specifically selected corresponding host file directory path. The default value points to current directory.</li>
<li><code>PROTOCOL_9P</code>: The 9P protocol selected, which can be either <code>9P2000.L</code> or <code>9P2000.u</code>. Default value is <code>9P2000.L</code>.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="user-library"><a class="header" href="#user-library">User Library</a></h1>
<p>This chapter will cover:</p>
<ul>
<li>
<p>What <a href="chap07/ulib/./ruxlibc.html">ruxlibc</a> is, and how to use ruxlibc</p>
</li>
<li>
<p>How musl libc is integrated and what is <a href="chap07/ulib/./ruxmusl.html">ruxmusl</a></p>
</li>
<li>
<p>What <a href="chap07/ulib/./ruxos-posix-api.html">ruxos-posix-api</a> is, and the difference between ruxos-posix-api and standard posix API</p>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ruxos-posix-api"><a class="header" href="#ruxos-posix-api">ruxos-posix-api</a></h1>
<p>The ruxos-posix-api layer provides APIs similar to the <a href="https://en.wikipedia.org/wiki/POSIX">posix</a> standard, to support <a href="chap07/ulib/./ruxlibc.html">ruxlibc</a> and <a href="chap07/ulib/./ruxmusl.html">ruxmusl</a>. The ruxos-posix-api layer features the following characteristics:</p>
<ul>
<li>
<p>APIs are designed and implemented based on POSIX standards.</p>
</li>
<li>
<p>APIs are implemented by Rust, providing both rust and C APIs with the same name.</p>
</li>
<li>
<p>Paying attention to the characteristics of the unikernel operating system, some posix APIs have been specially treated and implemented.</p>
</li>
<li>
<p><code>ruxos-posix-api</code> provides a variety of Rust features to reduce the kernel size.</p>
</li>
</ul>
<p>In this chapter, RuxOS Book will explain the purpose of <code>ruxos-posix-api</code> and the difference from the standard posix API.</p>
<h2 id="purpose"><a class="header" href="#purpose">Purpose</a></h2>
<p>In order to provide support for user libraries and standard C libraries, the POSIX standard defines a set of common APIs for compatibility between different systems. </p>
<p><code>ruxos-posix-api</code> provides the implementation of posix system calls. The number of parameters and parameter types strictly follow the posix system call standards, and is used to support the upper-layer ruxlibc and ruxmusl user libraries. Decoupling the user library from the system call layer facilitates system developers to better locate bugs and errors, making the hierarchical relationship more obvious.</p>
<h2 id="difference"><a class="header" href="#difference">Difference</a></h2>
<p><code>ruxos-posix-api</code> differs from the standard posix system call API in the following ways:</p>
<ul>
<li>
<p><a href="chap07/ulib/ruxos-posix-api.html#syscall-api-name">syscall API name</a></p>
</li>
<li>
<p><a href="chap07/ulib/ruxos-posix-api.html#detailed-syscall">detailed syscall</a></p>
</li>
<li>
<p><a href="chap07/ulib/ruxos-posix-api.html#architecture-ignored">architecture ignored</a></p>
</li>
</ul>
<h3 id="syscall-api-name"><a class="header" href="#syscall-api-name">syscall API name</a></h3>
<p>The system call name starts with <em>sys_</em> (see <a href="chap07/ulib/ruxos-posix-api.html#syscall-list">syscall list</a>), followed by the specific function name. </p>
<h3 id="detailed-syscall"><a class="header" href="#detailed-syscall">detailed syscall</a></h3>
<p>However, some syscall APIs in RuxOS are specifically used for <a href="chap07/ulib/./ruxlibc.html">ruxlibc</a> and are not in the posix standard library. These APIs are specially pointed out in <a href="chap07/ulib/ruxos-posix-api.html#syscall-list">syscall list</a>, like <code>sys_pthread_create</code>. </p>
<p>By adding more detailed syscalls and specializing the pthread library in particular, the purpose of this design is to shorten the function call path and parameter parsing time.</p>
<p>Due to the characteristics of the unikernel operating system, user programs and the kernel run at the same privilege level. Therefore, direct function calls instead of long system calls can improve program performance and reduce debugging time for programmers and developers.</p>
<p>Some specially treated APIs are explained in detail <a href="chap07/ulib/ruxos-posix-api.html#special-apis">below</a>.</p>
<h3 id="architecture-ignored"><a class="header" href="#architecture-ignored">architecture ignored</a></h3>
<p>In the standard POSIX syscall specification, different architectures have different system call numbers and system call names. </p>
<p>However, in ruxos-posix-api, we have not yet made a distinction. There may be mutual calls between system calls for simplicity.</p>
<h2 id="special-apis"><a class="header" href="#special-apis">Special APIs</a></h2>
<p>All APIs customized by RuxOS are marked in italics in the <a href="chap07/ulib/ruxos-posix-api.html#syscall-list">list</a>.</p>
<p>Some APIs are described and explained below.</p>
<h3 id="sys_clone-vs-sys_pthread_create"><a class="header" href="#sys_clone-vs-sys_pthread_create">sys_clone VS sys_pthread_create</a></h3>
<p>In libc, <code>sys_clone</code> is used to create threads or processes. The kernel determines whether to create a thread or a process by parsing the incoming flag, and sets the shared attributes of the new thread or new process. </p>
<p>In the unikernel operating system, RuxOS only supports one process and does not support the <code>fork</code> function. Therefore, RuxOS's <code>sys_clone</code> semantics only need to satisfy the creation of new threads, and new threads always share resources such as address space, file descriptor tables, signals, etc. with the parent thread.</p>
<p>By simplifying the semantics, RuxOS can complete thread creation faster and maintain the semantics of thread creation that are basically consistent with Linux. In <a href="chap07/ulib/./ruxlibc.html">ruxlibc</a>, syscalls become function calls, so RuxOS does not need to support the creation of new threads through <code>sys_clone</code>, but directly supports the implementation of <code>pthread_create</code> and just throws new tasks into the scheduling queue.</p>
<h3 id="sys_futex-vs-sys_mutex_xxx"><a class="header" href="#sys_futex-vs-sys_mutex_xxx">sys_futex VS sys_mutex_xxx</a></h3>
<p>In kernels such as Linux, futex is used to support mutex, etc., and synchronization is completed by monitoring the value of an address. </p>
<p>Since the kernel has provided various lock implementations, when supporting ruxlibc, RuxOS implemented the lock API starting with <code>pthread_mutex</code> to directly call the lock API implemented in kernel and is compatible with the lock definition in musl libc. </p>
<p>When supporting musl libc, RuxOS implemented a simplified version of futex semantics. When the value of the address monitored by the thread remains unchanged, the <code>yield </code>function will be called to actively give up the CPU.</p>
<h3 id="sys_mmap"><a class="header" href="#sys_mmap">sys_mmap</a></h3>
<p><code>mmap</code> maps a virtual address to the user program and allocates a specific physical address to the user program by processing page fault. </p>
<p>In RuxOS, since the user program has only one process and owns the entire physical address space, the current <code>mmap</code> is to directly allocate content of a given size to the user program and release it in <code>munmap</code>. At the same time, RuxOS does not support file mapping, so it does not handle fd.</p>
<h3 id="sys_pthread_key_xxx"><a class="header" href="#sys_pthread_key_xxx">sys_pthread_key_xxx</a></h3>
<p>The <code>pthread_key</code> related APIs provide thread-local key-value pairs. The implementation of this part should belong to libc. </p>
<p>In order to support these APIs more simply and directly, RuxOS puts the corresponding key-value into the <code>task_inner</code> structure, simplifying the implementation of ruxlibc. </p>
<p>In musl libc, this part is placed into a thread-related memory managed by musl libc, so RuxOS does not need to provide corresponding syscalls.</p>
<h3 id="sys_freeaddrinfo-sys_getaddrinfo"><a class="header" href="#sys_freeaddrinfo-sys_getaddrinfo">sys_freeaddrinfo, sys_getaddrinfo</a></h3>
<p>These two APIs in libc are to parse addresses and release corresponding data structures. Its implementation belongs to the libc layer, since it needs to read the <code>/etc/hosts</code> file on the local machine to send DNS queries, RuxOS has specially processed it to simplify the implementation.</p>
<h2 id="syscall-list"><a class="header" href="#syscall-list">syscall list</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Module Name</th><th>Syscall Name</th><th>Description</th></tr></thead><tbody>
<tr><td><strong>io_mpx</strong></td><td>sys_epoll_create</td><td>Create an epoll fd</td></tr>
<tr><td></td><td>sys_epoll_ctl</td><td>Control interface for an epoll file descriptor</td></tr>
<tr><td></td><td>sys_epoll_pwait, sys_epoll_wait</td><td>Wait for an I/O event on an epoll file descriptor</td></tr>
<tr><td></td><td>sys_poll, sys_ppoll</td><td>Wait for some event on a file descriptor</td></tr>
<tr><td></td><td>sys_pselect6, sys_select</td><td>Monitor multiple file descriptors</td></tr>
<tr><td><strong>io</strong></td><td>sys_read, sys_write</td><td>Read/Write from a fd</td></tr>
<tr><td></td><td>sys_readv, sys_writev</td><td>Read/Write data from/into multiple buffers</td></tr>
<tr><td><strong>resources</strong></td><td>sys_getrlimit, sys_prlimit64, sys_setrlimit</td><td>Get/Set resource limits</td></tr>
<tr><td><strong>rt_sig</strong></td><td>sys_rt_sigaction</td><td>Examine and change a signal action</td></tr>
<tr><td></td><td>sys_rt_sigprocmask</td><td>Examine and change blocked signals</td></tr>
<tr><td><strong>stat</strong></td><td>sys_umask</td><td>Set file mode creation mask</td></tr>
<tr><td><strong>sys</strong></td><td>sys_sysinfo</td><td>Return system information</td></tr>
<tr><td><strong>task</strong></td><td>sys_exit</td><td></td></tr>
<tr><td></td><td>sys_getpid</td><td></td></tr>
<tr><td></td><td>sys_sched_yield</td><td></td></tr>
<tr><td><strong>time</strong></td><td>sys_clock_gettime, sys_clock_settime</td><td></td></tr>
<tr><td></td><td>sys_nanosleep</td><td></td></tr>
<tr><td><strong>fd_ops</strong></td><td>sys_close</td><td></td></tr>
<tr><td></td><td>sys_dup, sys_dup2, sys_dup3</td><td></td></tr>
<tr><td></td><td>sys_fcntl</td><td></td></tr>
<tr><td><strong>fs</strong></td><td>sys_fdatasync, sys_fsync</td><td></td></tr>
<tr><td></td><td>sys_fstat, sys_lstat, sys_newfstatat, sys_stat</td><td></td></tr>
<tr><td></td><td>sys_getcwd</td><td></td></tr>
<tr><td></td><td>sys_open, sys_openat</td><td></td></tr>
<tr><td></td><td>sys_mkdir, sys_mkdirat</td><td></td></tr>
<tr><td></td><td>sys_rename, sys_renameat</td><td></td></tr>
<tr><td></td><td>sys_unlink, sys_unlinkat</td><td></td></tr>
<tr><td></td><td>sys_lseek</td><td></td></tr>
<tr><td></td><td>sys_rmdir</td><td></td></tr>
<tr><td><strong>ioctl</strong></td><td>sys_ioctl</td><td></td></tr>
<tr><td><strong>mmap</strong></td><td>sys_mmap, sys_munmap</td><td></td></tr>
<tr><td></td><td>sys_mprotect</td><td></td></tr>
<tr><td><strong>net</strong></td><td>sys_accept, sys_bind, sys_connect, sys_listen</td><td></td></tr>
<tr><td></td><td>sys_socket</td><td></td></tr>
<tr><td></td><td>sys_shutdown</td><td></td></tr>
<tr><td></td><td><em>sys_freeaddrinfo, sys_getaddrinfo</em></td><td></td></tr>
<tr><td></td><td>sys_recv, sys_recvfrom</td><td></td></tr>
<tr><td></td><td>sys_send, sys_sendmsg, sys_sendto</td><td></td></tr>
<tr><td></td><td>sys_getsockname</td><td></td></tr>
<tr><td></td><td>sys_setsockopt</td><td></td></tr>
<tr><td></td><td>sys_getpeername</td><td></td></tr>
<tr><td><strong>pipe</strong></td><td>sys_pipe, sys_pipe2</td><td></td></tr>
<tr><td><strong>signal</strong></td><td>sys_getitimer, sys_setitimer</td><td></td></tr>
<tr><td></td><td>sys_sigaction</td><td></td></tr>
<tr><td><strong>pthread</strong></td><td><em>sys_pthread_getspecific/setspecific</em></td><td></td></tr>
<tr><td></td><td><em>sys_pthread_key_create/delete</em></td><td></td></tr>
<tr><td></td><td><em>sys_pthread_create, sys_pthread_exit</em></td><td></td></tr>
<tr><td></td><td><em>sys_pthread_join</em></td><td></td></tr>
<tr><td></td><td><em>sys_pthread_self</em></td><td></td></tr>
<tr><td></td><td>sys_clone</td><td></td></tr>
<tr><td></td><td>sys_set_tid_address</td><td></td></tr>
<tr><td><strong>pthread::futex</strong></td><td>sys_futex</td><td></td></tr>
<tr><td><strong>pthread::condvar</strong></td><td><em>sys_pthread_cond_timedwait, sys_pthread_cond_wait</em></td><td></td></tr>
<tr><td></td><td><em>sys_pthread_cond_init/destroy</em></td><td></td></tr>
<tr><td></td><td><em>sys_pthread_cond_signal/broadcast</em></td><td></td></tr>
<tr><td><strong>pthread::mutex</strong></td><td><em>sys_pthread_mutex_destroy/init</em></td><td></td></tr>
<tr><td></td><td><em>sys_pthread_mutex_lock/trylock/unlock</em></td><td></td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="ruxlibc"><a class="header" href="#ruxlibc">ruxlibc</a></h1>
<p>Inspired by <a href="https://github.com/redox-os/relibc">relibc</a> and <a href="https://github.com/unikraft/unikraft/tree/staging/lib/nolibc">nolibc</a>, <code>ruxlibc</code> is a C user library implemented by Rust. Its main purposes are:</p>
<ul>
<li>
<p><strong>Small and concise</strong>. It only contains some of the most commonly used API implementations in libc, greatly reducing the size of the image file. <code>ruxlibc</code> uses Rust <code>feature</code> and the characteristics of the unikernel operating system to implement conditional compilation according to the application, so that the generated C user library only contains the modules necessary for the application.</p>
</li>
<li>
<p><strong>Based on Rust to ensure memory safety</strong>. Drawing inspiration from <code>relibc</code>, <code>ruxlibc</code> uses Rust to ensure memory safety as much as possible from the language level. At the same time, reasonable setting of error types and corresponding processing facilitates debugging by OS developers and application developers.</p>
</li>
</ul>
<h2 id="features"><a class="header" href="#features">Features</a></h2>
<p>The implementation of <code>ruxlibc</code> follows musl libc, and uses Rust <code>feature</code> to achieve tailoring. The features included are introduced below.</p>
<div class="table-wrapper"><table><thead><tr><th>Feature Name</th><th>Feature Description</th></tr></thead><tbody>
<tr><td>smp</td><td>Enable SMP (symmetric multiprocessing) support.</td></tr>
<tr><td>fp_simd</td><td>Enable floating point and SIMD support.</td></tr>
<tr><td>irq</td><td>Enable interrupt handling support.</td></tr>
<tr><td>alloc</td><td>Enable dynamic memory allocation.</td></tr>
<tr><td>tls</td><td>Enable thread-local storage.</td></tr>
<tr><td>multitask</td><td>Enable multi-threading support.</td></tr>
<tr><td>fs</td><td>Enable file system support.</td></tr>
<tr><td>net</td><td>Enable networking support.</td></tr>
<tr><td>signal</td><td>Enable signal support.</td></tr>
<tr><td>fd</td><td>Enable file descriptor table.</td></tr>
<tr><td>pipe</td><td>Enable pipe support.</td></tr>
<tr><td>select</td><td>Enable synchronous I/O multiplexing ([select]) support.</td></tr>
<tr><td>epoll</td><td>Enable event polling ([epoll]) support.</td></tr>
<tr><td>random-hw</td><td>Enable random number generation by hardware instruction.</td></tr>
</tbody></table>
</div>
<h2 id="how-to-use-ruxlibc"><a class="header" href="#how-to-use-ruxlibc">How to use ruxlibc</a></h2>
<p>See <a href="chap07/ulib/../../chap03/your_app.html">Your App</a> to use <code>ruxlibc</code> for C applications.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ruxmusl"><a class="header" href="#ruxmusl">ruxmusl</a></h1>
<p>This chapter introduces how <a href="https://www.musl-libc.org/">musl libc</a> is integrated to RuxOS. <code>ruxmusl</code> is tested by libc-bench.</p>
<h2 id="from-musl-libc-to-syscall"><a class="header" href="#from-musl-libc-to-syscall">From musl libc to syscall</a></h2>
<h3 id="importance-to-import-musl-libc"><a class="header" href="#importance-to-import-musl-libc">importance to import musl libc</a></h3>
<p><code>musl libc</code> provides corresponding C APIs to C programs and encapsulates the underlying system call API. At the same time, not all C functions require system calls. A large number of string processing functions do not require system calls. These functions that do not require system calls provide a relatively complete and efficient implementation in <code>musl libc</code>. </p>
<p>Therefore, after integrating <code>musl libc</code> into RuxOS, the string and other related functions implemented by the original ryxlibc are no longer needed, and more APIs are provided without the need to implement them one by one.</p>
<h3 id="system-call-number"><a class="header" href="#system-call-number">system call number</a></h3>
<p>System calls are a set of portable APIs defined by the kernel. The system call numbers corresponding to system calls of different architectures may be different. In AARCH64, you can get the A64-defined system calls and their call numbers by looking at <code>path/to/musl-libc/arch/aarch64/bits/syscall.h.in</code>.</p>
<p>Comparing the system calls of different architectures, we can find that not only the system call numbers are different, but the types are also different. For example, A64 provides two system calls, <code>dup</code> and <code>dup3</code>, but not <code>dup2</code>. <code>dup2</code> is implemented through <code>dup + fcntl</code>; but x86_64 provides <code>dup/dup2/dup3</code>.</p>
<h3 id="trigger-a-synchronization-exception"><a class="header" href="#trigger-a-synchronization-exception">trigger a synchronization exception</a></h3>
<p>How to enter the kernel system call layer from the libc function? Take the <code>read()</code> function as an example.</p>
<ul>
<li>
<p><code>read()</code> is a function provided by the C standard library and is implemented in <code>path/to/musl-libc/src/unistd/read.c</code>. You can see that <code>syscall_cp(SYS_read, fd, buf, count)</code> is called. Here, the system call is called through macro, defined in <code>path/to/musl/arch/aarch64/syscall_arch.h</code>. You can see that <code>svc 0</code> is passed here, and the relevant parameters are stored in <code>x0~x5</code>, and the system call number is stored in <code>x8</code>, which means that up to 6 parameters are supported.</p>
</li>
<li>
<p><code>svc 0</code> will trigger an interrupt and enter the kernel's interrupt exception vector table. It will trigger a synchronization exception, which will be taken over and processed by the kernel. </p>
</li>
</ul>
<h2 id="system-call-handling-a64"><a class="header" href="#system-call-handling-a64">System call handling (A64)</a></h2>
<h3 id="parse-parameters"><a class="header" href="#parse-parameters">parse parameters</a></h3>
<p>The synchronization exception will enter <code>handle_sync_exception()</code> in <code>modules/ruxhal/src/arch/aarch64/trap.rs</code> of RuxOS. The exception triggering cause is obtained by parsing the <code>ESR</code> exception status register, and the system call parameters and system call number are obtained by reading <code>x0~x5</code> and <code>x8</code>.Then enter the system call processing function.</p>
<p>The function <code>handle_syscall()</code> is added to the <code>TrapHandler</code> trait in <code>modules/ruxhal/src/trap.rs</code>, and is only available with <code>MUSL</code> feature. The implementation is in <code>ulib/ruxmusl/src/trap.rs</code>. System call number is parsed here and then distributed to corresponded handling function.</p>
<h3 id="system-call-distribution"><a class="header" href="#system-call-distribution">system call distribution</a></h3>
<p>The distribution process is in <code>ulib/ruxmusl/src/syscall/mod.rs</code>, and the system call number is defined in <code>ulib/ruxmusl/src/syscall/syscall_id.rs</code>. It is consistent with the standard system call number (A64), but it is not yet complete. The distribution process is matching system call numbers, parsing different numbers of parameters according to the system call number, and then calling the specific system call implementation in <a href="chap07/ulib/./ruxos-posix-api.html"><code>ruxos-posix-api</code></a>.</p>
<h2 id="use-ruxmusl"><a class="header" href="#use-ruxmusl">Use ruxmusl</a></h2>
<p>The relevant makefile has been modified to integrate the <code>MUSL</code> feature. When compiling a C program, <strong>add <code>MUSL=y</code> to compile the application</strong> through <code>musl libc</code>.</p>
<p>Some of the features that <code>ruxmusl</code> must include have been added to the makefile, and no additional work is required:</p>
<ul>
<li><strong>fp_simd</strong>: Since musl needs to compile all C standard library functions involving <code>double</code> types, floating point registers are needed.</li>
<li><strong>fd</strong>: Since musl needs to initialize stdin/stdout/stderr in the form of a file, this feature needs to be turned on.</li>
<li><strong>tls</strong>: <code>musl libc</code> manages tls by itself in the thread, and needs to get things like <code>pthread_self()</code> through <code>tls</code>, so it needs to be turned on.</li>
</ul>
<p>RuxOS will automatically pull and compile the musl libc source code. Users must add <code>ARCH=aarch64</code> because it is currently only integrated for A64.</p>
<p>The compilation process is similar to the previous ruxlibc. The previous ruxlibc will compile a <code>.a</code> file under the <code>target/</code> directory, and <code>musl libc</code> will also generate a <code>libc.a</code> file under the <code>install/</code> directory after compilation. Use this <code>.a</code> file for linking (already integrated into makefile).</p>
<div style="break-before: page; page-break-before: always;"></div>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
