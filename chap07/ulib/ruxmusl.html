<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>ruxmusl - RuxOS Book</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="RuxOS guide book">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../Introduction.html">Introduction</a></li><li class="chapter-item expanded affix "><li class="part-title">About RuxOS</li><li class="chapter-item expanded "><a href="../../chap01/Overview.html"><strong aria-hidden="true">1.</strong> RuxOS overview</a></li><li class="chapter-item expanded affix "><li class="part-title">Getting Started with RuxOS</li><li class="chapter-item expanded "><a href="../../chap02/getstarted.html"><strong aria-hidden="true">2.</strong> Get Started</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../chap02/arguments.html"><strong aria-hidden="true">2.1.</strong> Arguments</a></li><li class="chapter-item expanded "><a href="../../chap02/apps/root.html"><strong aria-hidden="true">2.2.</strong> Existing apps</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../chap02/apps/helloworld.html"><strong aria-hidden="true">2.2.1.</strong> Hello World!</a></li><li class="chapter-item expanded "><a href="../../chap02/apps/iperf.html"><strong aria-hidden="true">2.2.2.</strong> Iperf3</a></li><li class="chapter-item expanded "><a href="../../chap02/apps/sqlite.html"><strong aria-hidden="true">2.2.3.</strong> Sqlite</a></li><li class="chapter-item expanded "><a href="../../chap02/apps/redis.html"><strong aria-hidden="true">2.2.4.</strong> Redis</a></li><li class="chapter-item expanded "><a href="../../chap02/apps/nginx.html"><strong aria-hidden="true">2.2.5.</strong> Nginx</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../chap03/your_app.html"><strong aria-hidden="true">3.</strong> Your App</a></li><li class="chapter-item expanded "><a href="../../chap04/ruxgo.html"><strong aria-hidden="true">4.</strong> Build from ruxgo</a></li><li class="chapter-item expanded "><a href="../../chap05/multiplatforms.html"><strong aria-hidden="true">5.</strong> Multi-Platforms</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../chap05/Raspi4.html"><strong aria-hidden="true">5.1.</strong> Raspi4</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Architeture and Design</li><li class="chapter-item expanded "><a href="../../chap06/design_overview.html"><strong aria-hidden="true">6.</strong> Design Overview</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../chap06/crates/crates.html"><strong aria-hidden="true">6.1.</strong> Crates</a></li><li class="chapter-item expanded "><a href="../../chap06/modules/modules.html"><strong aria-hidden="true">6.2.</strong> Modules</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../chap06/modules/9pfs.html"><strong aria-hidden="true">6.2.1.</strong> 9pfs</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../chap07/ulib/ulib.html"><strong aria-hidden="true">7.</strong> User Library</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../chap07/ulib/ruxos-posix-api.html"><strong aria-hidden="true">7.1.</strong> ruxos-posix-api</a></li><li class="chapter-item expanded "><a href="../../chap07/ulib/ruxlibc.html"><strong aria-hidden="true">7.2.</strong> ruxlibc</a></li><li class="chapter-item expanded "><a href="../../chap07/ulib/ruxmusl.html" class="active"><strong aria-hidden="true">7.3.</strong> ruxmusl</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Future Work</li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.</strong> TODO</div></li><li class="spacer"></li><li class="chapter-item expanded affix "><a href="../../Contributors.html">CONTRIBUTORS</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">RuxOS Book</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/syswonder/ruxos" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="ruxmusl"><a class="header" href="#ruxmusl">ruxmusl</a></h1>
<p>This chapter introduces how <a href="https://www.musl-libc.org/">musl libc</a> is integrated to RuxOS. <code>ruxmusl</code> is tested by libc-bench.</p>
<h2 id="from-musl-libc-to-syscall"><a class="header" href="#from-musl-libc-to-syscall">From musl libc to syscall</a></h2>
<h3 id="importance-to-import-musl-libc"><a class="header" href="#importance-to-import-musl-libc">importance to import musl libc</a></h3>
<p><code>musl libc</code> provides corresponding C APIs to C programs and encapsulates the underlying system call API. At the same time, not all C functions require system calls. A large number of string processing functions do not require system calls. These functions that do not require system calls provide a relatively complete and efficient implementation in <code>musl libc</code>. </p>
<p>Therefore, after integrating <code>musl libc</code> into RuxOS, the string and other related functions implemented by the original ryxlibc are no longer needed, and more APIs are provided without the need to implement them one by one.</p>
<h3 id="system-call-number"><a class="header" href="#system-call-number">system call number</a></h3>
<p>System calls are a set of portable APIs defined by the kernel. The system call numbers corresponding to system calls of different architectures may be different. In AARCH64, you can get the A64-defined system calls and their call numbers by looking at <code>path/to/musl-libc/arch/aarch64/bits/syscall.h.in</code>.</p>
<p>Comparing the system calls of different architectures, we can find that not only the system call numbers are different, but the types are also different. For example, A64 provides two system calls, <code>dup</code> and <code>dup3</code>, but not <code>dup2</code>. <code>dup2</code> is implemented through <code>dup + fcntl</code>; but x86_64 provides <code>dup/dup2/dup3</code>.</p>
<h3 id="trigger-a-synchronization-exception"><a class="header" href="#trigger-a-synchronization-exception">trigger a synchronization exception</a></h3>
<p>How to enter the kernel system call layer from the libc function? Take the <code>read()</code> function as an example.</p>
<ul>
<li>
<p><code>read()</code> is a function provided by the C standard library and is implemented in <code>path/to/musl-libc/src/unistd/read.c</code>. You can see that <code>syscall_cp(SYS_read, fd, buf, count)</code> is called. Here, the system call is called through macro, defined in <code>path/to/musl/arch/aarch64/syscall_arch.h</code>. You can see that <code>svc 0</code> is passed here, and the relevant parameters are stored in <code>x0~x5</code>, and the system call number is stored in <code>x8</code>, which means that up to 6 parameters are supported.</p>
</li>
<li>
<p><code>svc 0</code> will trigger an interrupt and enter the kernel's interrupt exception vector table. It will trigger a synchronization exception, which will be taken over and processed by the kernel. </p>
</li>
</ul>
<h2 id="system-call-handling-a64"><a class="header" href="#system-call-handling-a64">System call handling (A64)</a></h2>
<h3 id="parse-parameters"><a class="header" href="#parse-parameters">parse parameters</a></h3>
<p>The synchronization exception will enter <code>handle_sync_exception()</code> in <code>modules/ruxhal/src/arch/aarch64/trap.rs</code> of RuxOS. The exception triggering cause is obtained by parsing the <code>ESR</code> exception status register, and the system call parameters and system call number are obtained by reading <code>x0~x5</code> and <code>x8</code>.Then enter the system call processing function.</p>
<p>The function <code>handle_syscall()</code> is added to the <code>TrapHandler</code> trait in <code>modules/ruxhal/src/trap.rs</code>, and is only available with <code>MUSL</code> feature. The implementation is in <code>ulib/ruxmusl/src/trap.rs</code>. System call number is parsed here and then distributed to corresponded handling function.</p>
<h3 id="system-call-distribution"><a class="header" href="#system-call-distribution">system call distribution</a></h3>
<p>The distribution process is in <code>ulib/ruxmusl/src/syscall/mod.rs</code>, and the system call number is defined in <code>ulib/ruxmusl/src/syscall/syscall_id.rs</code>. It is consistent with the standard system call number (A64), but it is not yet complete. The distribution process is matching system call numbers, parsing different numbers of parameters according to the system call number, and then calling the specific system call implementation in <a href="./ruxos-posix-api.html"><code>ruxos-posix-api</code></a>.</p>
<h2 id="use-ruxmusl"><a class="header" href="#use-ruxmusl">Use ruxmusl</a></h2>
<p>The relevant makefile has been modified to integrate the <code>MUSL</code> feature. When compiling a C program, <strong>add <code>MUSL=y</code> to compile the application</strong> through <code>musl libc</code>.</p>
<p>Some of the features that <code>ruxmusl</code> must include have been added to the makefile, and no additional work is required:</p>
<ul>
<li><strong>fp_simd</strong>: Since musl needs to compile all C standard library functions involving <code>double</code> types, floating point registers are needed.</li>
<li><strong>fd</strong>: Since musl needs to initialize stdin/stdout/stderr in the form of a file, this feature needs to be turned on.</li>
<li><strong>tls</strong>: <code>musl libc</code> manages tls by itself in the thread, and needs to get things like <code>pthread_self()</code> through <code>tls</code>, so it needs to be turned on.</li>
</ul>
<p>RuxOS will automatically pull and compile the musl libc source code. Users must add <code>ARCH=aarch64</code> because it is currently only integrated for A64.</p>
<p>The compilation process is similar to the previous ruxlibc. The previous ruxlibc will compile a <code>.a</code> file under the <code>target/</code> directory, and <code>musl libc</code> will also generate a <code>libc.a</code> file under the <code>install/</code> directory after compilation. Use this <code>.a</code> file for linking (already integrated into makefile).</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../chap07/ulib/ruxlibc.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../Contributors.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../chap07/ulib/ruxlibc.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../Contributors.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
